parameters:
- name: Part
  type: string
  values:
  - Part1
  - Part2

steps:
- task: PowerShell@1
  inputs:
    scriptName: "$(Build.Repository.LocalPath)\\scripts\\utils\\InstallCLIforBuild.ps1"
    arguments: '$(SDKVersionForBuild)'
  displayName: "Install .NET 5.0 for build"

- task: PowerShell@1
  displayName: "Define variables"
  inputs:
    scriptType: "inlineScript"
    inlineScript: |
      Write-Host "##vso[task.setvariable variable=Path]${env:AGENT_TEMPDIRECTORY}\dotnet\;${env:Path}"

- task: PowerShell@1
  displayName: "Define variables for deviding end to end tests"
  inputs:
    scriptType: "inlineScript"
    inlineScript: |
      $Part1 = "InstallPackageTest.ps1,UninstallPackageTest.ps1,UpdatePackageTest.ps1,PackageRestoreTest.ps1"
      $Part2 = "A-TopDownloadedPackages.ps1,BuildIntegratedTest.ps1,ExecuteInitScriptTest.ps1,FindPackageTest.ps1,GetPackageTest.ps1,GetProjectTest.ps1,LegacyPackageRefProjectTest.ps1,NativeProjectTest.ps1,NetCoreProjectTest.ps1,PackTest.ps1,ProjectRetargeting.ps1,ServicesTest.ps1,Settings.ps1,SyncPackageTest.ps1,TabExpansionTest.ps1,UniversalWindowsProjectTest.ps1"
      $EndToEndTestCommandToRunPart1 = '"' + "Run-Test -Exclude '$Part2' -Verbose *>&1 | Tee-Object $(System.DefaultWorkingDirectory)\artifacts\EndToEnd\FullLog_$(Build.BuildNumber).txt" +'"'
      $EndToEndTestCommandToRunPart2 = '"' + "Run-Test -Exclude '$Part1' -Verbose *>&1 | Tee-Object $(System.DefaultWorkingDirectory)\artifacts\EndToEnd\FullLog_$(Build.BuildNumber).txt" +'"'
      Write-Host "##vso[task.setvariable variable=EndToEndTestCommandToRunPart1]$EndToEndTestCommandToRunPart1"
      Write-Host "##vso[task.setvariable variable=EndToEndTestCommandToRunPart2]$EndToEndTestCommandToRunPart2"

- task: PowerShell@1
  displayName: "Print Environment Variables"
  inputs:
    scriptType: "inlineScript"
    inlineScript: |
      Write-Host "##vso[build.updatebuildnumber]$env:FullVstsBuildNumber"
      Get-ChildItem Env: | Sort-Object Name | Format-Table -Wrap -AutoSize

- task: DownloadBuildArtifacts@0
  displayName: "Download Build artifacts"
  inputs:
    artifactName: "$(VsixPublishDir)"
    downloadPath: "$(Build.Repository.LocalPath)/artifacts"

- task: PowerShell@1
  displayName: "Bootstrap.ps1"
  inputs:
    scriptName: "$(System.DefaultWorkingDirectory)/scripts/e2etests/Bootstrap.ps1"
    arguments: "-NuGetDropPath $(Build.Repository.LocalPath)\\artifacts\\$(VsixPublishDir) -FuncTestRoot $(System.DefaultWorkingDirectory)\\artifacts -verbose"

- task: PowerShell@1
  displayName: "SetupFunctionalTests.ps1"
  inputs:
    scriptName: "$(System.DefaultWorkingDirectory)\\artifacts\\EndToEnd\\scripts\\SetupFunctionalTests.ps1"

- task: PowerShell@1
  displayName: "SetupMachine.ps1"
  inputs:
    scriptName: "$(System.DefaultWorkingDirectory)\\artifacts\\EndToEnd\\scripts\\SetupMachine.ps1"

- task: PowerShell@1
  displayName: "InstallNuGetVSIX.ps1"
  inputs:
    scriptName: "$(System.DefaultWorkingDirectory)\\artifacts\\EndToEnd\\scripts\\InstallNuGetVSIX.ps1"
    arguments: "-NuGetDropPath $(System.DefaultWorkingDirectory)\\artifacts\\$(VsixPublishDir) -FuncTestRoot $(System.DefaultWorkingDirectory)\\artifacts -NuGetVSIXID $(NuGetVsixId) -ProcessExitTimeoutInSeconds 180 -VSVersion 16.0"
    failOnStandardError: "false"

- task: PowerShell@1
  displayName: "Collect VS Logs"
  inputs:
    scriptType: "inlineScript"
    inlineScript: |
      Invoke-WebRequest -Uri $(CollectExeUrl) -OutFile $(System.DefaultWorkingDirectory)\\VSCollect.exe
      $(System.DefaultWorkingDirectory)\\VSCollect.exe -zip:$(System.DefaultWorkingDirectory)\\artifacts\\EndToEnd\\e2e-collectlogs.zip
  condition: "failed()"

- ${{ if eq(parameters.Part, 'Part1') }}:
  - task: PowerShell@1
    displayName: "RunFunctionalTests.ps1 (stop on error)"
    timeoutInMinutes: 75
    continueOnError: "true"
    inputs:
      scriptName: "$(System.DefaultWorkingDirectory)\\artifacts\\EndToEnd\\scripts\\RunFunctionalTests.ps1"
      arguments: "-PMCCommand $(EndToEndTestCommandToRunPart1) -PMCLaunchWaitTimeInSecs 30 -EachTestTimoutInSecs 600 -NuGetDropPath $(System.DefaultWorkingDirectory)\\artifacts -FuncTestRoot $(System.DefaultWorkingDirectory)\\artifacts -RunCounter $(Build.BuildNumber) -VSVersion 16.0"
    condition: "eq(variables['IsOfficialBuild'], 'true')"

  - task: PowerShell@1
    displayName: "RunFunctionalTests.ps1 (continue on error)"
    timeoutInMinutes: 75
    continueOnError: "true"
    inputs:
      scriptName: "$(System.DefaultWorkingDirectory)\\artifacts\\EndToEnd\\scripts\\RunFunctionalTests.ps1"
      arguments: "-PMCCommand $(EndToEndTestCommandToRunPart1) -PMCLaunchWaitTimeInSecs 30 -EachTestTimoutInSecs 600 -NuGetDropPath $(System.DefaultWorkingDirectory)\\artifacts -FuncTestRoot $(System.DefaultWorkingDirectory)\\artifacts -RunCounter $(Build.BuildNumber) -VSVersion 16.0"
    condition: "not(eq(variables['IsOfficialBuild'], 'true'))"

- ${{ if eq(parameters.Part, 'Part2') }}:
  - task: PowerShell@1
    displayName: "RunFunctionalTests.ps1 (stop on error)"
    timeoutInMinutes: 75
    continueOnError: "true"
    inputs:
      scriptName: "$(System.DefaultWorkingDirectory)\\artifacts\\EndToEnd\\scripts\\RunFunctionalTests.ps1"
      arguments: "-PMCCommand $(EndToEndTestCommandToRunPart2) -PMCLaunchWaitTimeInSecs 30 -EachTestTimoutInSecs 600 -NuGetDropPath $(System.DefaultWorkingDirectory)\\artifacts -FuncTestRoot $(System.DefaultWorkingDirectory)\\artifacts -RunCounter $(Build.BuildNumber) -VSVersion 16.0"
    condition: "eq(variables['IsOfficialBuild'], 'true')"

  - task: PowerShell@1
    displayName: "RunFunctionalTests.ps1 (continue on error)"
    timeoutInMinutes: 75
    continueOnError: "false"
    inputs:
      scriptName: "$(System.DefaultWorkingDirectory)\\artifacts\\EndToEnd\\scripts\\RunFunctionalTests.ps1"
      arguments: "-PMCCommand $(EndToEndTestCommandToRunPart2) -PMCLaunchWaitTimeInSecs 30 -EachTestTimoutInSecs 600 -NuGetDropPath $(System.DefaultWorkingDirectory)\\artifacts -FuncTestRoot $(System.DefaultWorkingDirectory)\\artifacts -RunCounter $(Build.BuildNumber) -VSVersion 16.0"
    condition: "not(eq(variables['IsOfficialBuild'], 'true'))"

- task: PublishTestResults@2
  displayName: "Publish Test Results"
  inputs:
    testRunner: "JUnit"
    testResultsFiles: "*.xml"
    searchFolder: "$(System.DefaultWorkingDirectory)\\testresults"
    mergeTestResults: "true"
    testRunTitle: "NuGet.Client EndToEnd Tests On Windows"
  condition: "succeededOrFailed()"

- task: PowerShell@1
  displayName: "Initialize Git Commit Status on GitHub"
  inputs:
    scriptType: "inlineScript"
    arguments: "-VstsPersonalAccessToken $(VstsPersonalAccessToken)"
    inlineScript: |
      . $(Build.Repository.LocalPath)\\scripts\\utils\\PostGitCommitStatus.ps1
      SetCommitStatusForTestResult -PersonalAccessToken $(NuGetLurkerPersonalAccessToken) -VstsPersonalAccessToken $(VstsPersonalAccessToken) -CommitSha $(Build.SourceVersion) -TestName "EndToEnd Tests On Windows"
  condition: "always()"

- task: PowerShell@1
  displayName: "Kill running instances of DevEnv"
  inputs:
    scriptType: "inlineScript"
    inlineScript: |
      . $(Build.Repository.LocalPath)\\scripts\\e2etests\\VSUtils.ps1
      KillRunningInstancesOfVS
  condition: "always()"